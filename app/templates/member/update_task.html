{% extends 'base_member.html' %}
{% block title %}Cáº­p nháº­t cÃ´ng viá»‡c{% endblock %}

{% block content %}
  <h2>Cáº­p nháº­t task: {{ task.title }}</h2>

  <form method="post">
    {{ task_form.hidden_tag() }}
    {{ progress_form.hidden_tag() }}

    <div class="form-group">
      {{ task_form.status.label(class_='form-label') }}
      {{ task_form.status(class_='form-control') }}
    </div>
    <div class="form-group">
      {{ task_form.progress.label(class_='form-label') }}
      {{ task_form.progress(class_='form-control', min=0, max=100) }}
    </div>

    <hr>

    <!-- Pháº§n nháº­p tiáº¿n Ä‘á»™ háº±ng ngÃ y -->
    <h3>Tiáº¿n Ä‘á»™ hÃ´m nay</h3>
    <div class="form-group">
      {{ progress_form.description.label(class_='form-label') }}
      {{ progress_form.description(class_='form-control', rows=4) }}
    </div>

    <button type="submit" name="submit_all" class="btn btn-primary">LÆ°u tiáº¿n Ä‘á»™</button>
    <a href="{{ url_for('member.dashboard') }}" class="btn btn-secondary">Huá»·</a>
  </form>

  <!-- Danh sÃ¡ch tiáº¿n Ä‘á»™ -->
  <ul class="mt-3 list-group">
    {% for e in entries %}
      <li class="list-group-item">
        <strong>{{ e.date.strftime('%d-%m-%Y') }}</strong>: {{ e.description }}
      </li>
    {% else %}
      <li class="list-group-item text-muted">ChÆ°a cÃ³ tiáº¿n Ä‘á»™ nÃ o cho hÃ´m nay.</li>
    {% endfor %}
  </ul>

  {% if is_admin %}
    <hr>
    <!-- Pháº§n gá»­i pháº£n há»“i cá»§a admin -->
    <h3>Pháº£n há»“i cho thÃ nh viÃªn</h3>
    <form method="post">
      {{ feedback_form.hidden_tag() }}
      <div class="form-group">
        {{ feedback_form.content.label(class_='form-label') }}
        {{ feedback_form.content(class_='form-control', rows=4) }}
      </div>
      <button type="submit" class="btn btn-warning mt-2">{{ feedback_form.submit.label.text }}</button>
    </form>
  {% endif %}

  {% if feedbacks %}
    <hr>
    <h4>Pháº£n há»“i tá»« admin</h4>
    <ul class="list-group">
      {% for f in feedbacks %}
        <li class="list-group-item">
          <strong>{{ f.admin.username }}</strong> ({{ f.date.strftime('%d-%m-%Y %H:%M') }}):<br>
          {{ f.content }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();
    const currentTaskId = Number("{{ task.id }}");

    socket.on("connect", () => {
      console.log("âœ… Socket Ä‘Ã£ káº¿t ná»‘i (member):", socket.id);
      socket.emit("join");
    });

    socket.on("task_updated", data => {
      console.log("ðŸ”„ Task updated:", data);
      if (data.task_id === currentTaskId) {
        alert(`Task Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t:\nTráº¡ng thÃ¡i: ${data.status}\nTiáº¿n Ä‘á»™: ${data.progress}%`);
        location.reload();
      }
    });
  </script>
{% endblock %}
