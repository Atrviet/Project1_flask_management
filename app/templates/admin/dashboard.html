{% extends 'base.html' %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Qu·∫£n tr·ªã th√†nh vi√™n</h1>
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">

<div class="grid grid-cols-2 gap-6">
  <!-- Form t·∫°o / ch·ªânh s·ª≠a th√†nh vi√™n -->
  <div class="p-6 bg-white rounded-lg shadow">
    <h2 class="text-xl font-semibold mb-4">{{ 'Ch·ªânh s·ª≠a th√†nh vi√™n' if edit_id else 'T·∫°o th√†nh vi√™n m·ªõi' }}</h2>
    <form method="POST">
      {{ form.hidden_tag() }}
      {{ form.id }}
      <div class="mb-3">
        {{ form.username.label(class="block font-medium mb-1") }}
        {% if edit_id %}
          <input type="text" value="{{ form.username.data }}" disabled class="border p-2 w-full bg-gray-100 rounded">
        {% else %}
          {{ form.username(class="border p-2 w-full rounded") }}
        {% endif %}
      </div>
      <div class="mb-3">
        {{ form.fullname.label(class="block font-medium mb-1") }}
        {{ form.fullname(class="border p-2 w-full rounded") }}
      </div>
      <div class="mb-3">
        {{ form.email.label(class="block font-medium mb-1") }}
        {{ form.email(class="border p-2 w-full rounded") }}
      </div>
      <div class="mb-3">
        {{ form.password.label(class="block font-medium mb-1") }}
        {{ form.password(class="border p-2 w-full rounded") }}
      </div>
      <div class="mb-3">
        {{ form.confirm_password.label(class="block font-medium mb-1") }}
        {{ form.confirm_password(class="border p-2 w-full rounded") }}
      </div>
      <div class="flex items-center space-x-4">
        {{ form.submit(class="px-4 py-2 bg-green-600 text-white rounded shadow") }}
        {% if edit_id %}
          <a href="{{ url_for('admin.dashboard') }}" class="text-gray-600 underline">H·ªßy</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Danh s√°ch th√†nh vi√™n -->
  <div class="p-6 bg-white rounded-lg shadow">
    <h2 class="text-xl font-semibold mb-4">Danh s√°ch th√†nh vi√™n</h2>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-sm font-medium">Username</th>
          <th class="px-4 py-2 text-left text-sm font-medium">H·ªç t√™n</th>
          <th class="px-4 py-2 text-left text-sm font-medium">Email</th>
          <th class="px-4 py-2 text-left text-sm font-medium">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for m in members %}
        <tr>
          <td class="px-4 py-2">{{ m.username }}</td>
          <td class="px-4 py-2">{{ m.fullname }}</td>
          <td class="px-4 py-2">{{ m.email }}</td>
          <td class="px-4 py-2 space-x-2">
            <a href="{{ url_for('admin.dashboard', edit_id=m.id) }}"
               class="text-blue-600 underline">S·ª≠a</a>
      
            <form method="POST"
                  action="{{ url_for('admin.delete_member', user_id=m.id) }}"
                  class="inline">
              {{ form.hidden_tag() }}
              <button type="submit"
                      onclick="return confirm('X√≥a th√†nh vi√™n n√†y?');"
                      class="text-red-600 underline">X√≥a</button>
            </form>
      
            <!-- Giao nhi·ªám v·ª• -->
            <a href="{{ url_for('admin.assign_task', user_id=m.id) }}"
               class="px-3 py-1 bg-blue-600 text-white rounded">
              Giao nhi·ªám v·ª•
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Ph√¢n trang -->
    <div class="mt-4 flex justify-between items-center">
      {% if pagination.has_prev %}
        <a href="{{ url_for('admin.dashboard', page=pagination.prev_num) }}" class="underline">¬´ Prev</a>
      {% else %}
        <span class="text-gray-400">¬´ Prev</span>
      {% endif %}
      <span>Trang {{ pagination.page }} / {{ pagination.pages }}</span>
      {% if pagination.has_next %}
        <a href="{{ url_for('admin.dashboard', page=pagination.next_num) }}" class="underline">Next ¬ª</a>
      {% else %}
        <span class="text-gray-400">Next ¬ª</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="container mx-auto py-6">
  <!-- Panel giao nhi·ªám v·ª• -->
  <div class="mt-6 p-6 bg-white rounded-lg shadow">
    {% if assign_id and assign_member %}
      <h2 class="text-xl font-semibold mb-4">Giao nhi·ªám v·ª• cho {{ assign_member.username }}</h2>
      <form id="assignForm" method="POST" 
        enctype="multipart/form-data" 
        action="{{ url_for('admin.assign_task', user_id=assign_member.id) }}">
        {{ assign_form.hidden_tag() }}
        <!--From giao nhi·ªám v·ª•-->
        <div class="mb-3">
          {{ assign_form.title.label(class="block font-medium mb-1") }}
          {{ assign_form.title(class="border p-2 w-full rounded") }}
        </div>
        <div class="mb-3">
          {{ assign_form.description.label(class="block font-medium mb-1") }}
          {{ assign_form.description(class="border p-2 w-full rounded") }}
        </div>
        <div class="mb-3">
          {{ assign_form.file.label(class="block font-medium mb-1") }}
          {{ assign_form.file(class="w-full") }}
        </div>

        <!-- Progress bar container -->
        <div id="progressContainer" class="mb-3" style="display: none;">
          <label for="progressBar" class="block font-medium mb-1">Ti·∫øn tr√¨nh t·∫£i l√™n:</label>
          <progress id="progressBar" value="0" max="100" class="w-full rounded"></progress>
          <span id="percentDisplay" class="inline-block mt-1">0%</span>
        </div>

        <div class="mb-3">
          {{ assign_form.deadline.label(class="block font-medium mb-1") }}
          {{ assign_form.deadline(class="border p-2 w-full rounded") }}
        </div>
        <div>
          <button type="submit" name="assign_submit" id="assignButton" class="px-4 py-2 bg-blue-600 text-white rounded shadow">Giao nhi·ªám v·ª•</button>
        </div>
      </form>
    {% else %}
      <h2 class="text-xl font-semibold mb-2">Ch·ªçn th√†nh vi√™n ƒë·ªÉ giao nhi·ªám v·ª•</h2>
      <p>Nh·∫•n "Giao nhi·ªám v·ª•" b√™n m·ª•c Th√†nh vi√™n ƒë·ªÉ m·ªü form.</p>
    {% endif %}
  </div>
</div>
<!-- Panel hi·ªÉn th·ªã T·∫•t c·∫£ ti·∫øn ƒë·ªô -->
<div class="progress-panel">
  <h2 class="progress-title">T·∫•t c·∫£ ti·∫øn ƒë·ªô</h2>

  {% if progress_entries_all %}
    <div class="progress-grid">
      {% for p in progress_entries_all %}
      <div class="progress-card">
        <div class="progress-card-header">
          <div>
            <div class="progress-task-name">üìù {{ p.task.title }}</div>
            <div class="progress-task-date">{{ p.date.strftime('%d-%m-%Y %H:%M') }}</div>
          </div>
          {% if p.user %}
          <div class="progress-user">üë§ {{ p.user.username }}</div>
          {% endif %}
        </div>
        <div class="progress-description">{{ p.description }}</div>
        
        <!-- N√∫t X√≥a ti·∫øn ƒë·ªô -->
        <form action="{{ url_for('admin.delete_progress', progress_id=p.id) }}" method="POST" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ti·∫øn ƒë·ªô n√†y?');">
          <!-- CSRF Token -->
          {{ form.hidden_tag() }}
          <button type="submit" class="btn-delete">X√≥a</button>
        </form>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500">Ch∆∞a c√≥ b·∫£n ghi ti·∫øn ƒë·ªô n√†o.</p>
  {% endif %}
</div>


<!--Panel feedback-->
{% if assign_id and assign_member %}
  <div class="mt-6 p-6 bg-white rounded-lg shadow">
    <h2 class="text-xl font-semibold mb-4">Ph·∫£n h·ªìi ti·∫øn ƒë·ªô: {{ assign_member.username }}</h2>

    {# Danh s√°ch ti·∫øn ƒë·ªô c·ªßa member #}
    <ul class="list-group mb-4">
      {% for p in progress_entries %}
      <li class="list-group-item mb-3">
        <div>
          <strong>Ng√†y {{ p.date.strftime('%d-%m-%Y') }}</strong>:<br>
          {{ p.description }}
        </div>

        {# Show existing feedbacks #}
        {% for f in p.feedbacks %}
        <div class="mt-2 p-2 bg-gray-100 rounded">
          <small><strong>{{ f.admin.username }}</strong> ({{ f.date.strftime('%H:%M %d-%m-%Y') }}):</small><br>
          {{ f.content }}
        </div>
        {% endfor %}

        {# Form g·ª≠i feedback cho b·∫£n ghi n√†y #}
        <form method="post" action="{{ url_for('admin.task_feedbacks', task_id=task.id) }}" class="mt-3">
          {{ feedback_form.hidden_tag() }}
          <input type="hidden" name="progress_id" value="{{ p.id }}">
          <div class="form-group">
            {{ feedback_form.content(class="border p-2 w-full rounded", rows=2) }}
          </div>
          <button type="submit" class="px-3 py-1 bg-yellow-500 text-white rounded mt-1">{{ feedback_form.submit.label.text }}</button>
        </form>
      </li>
      {% else %}
      <li class="list-group-item text-muted">Ch∆∞a c√≥ ti·∫øn ƒë·ªô n√†o ƒë·ªÉ ph·∫£n h·ªìi.</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();

    socket.on('connect', () => {
      console.log('‚úÖ Admin socket connected:', socket.id);
      socket.emit('join');   // server s·∫Ω join_room('admins') n·∫øu role=admin
    });

    // task m·ªõi ƒë∆∞·ª£c admin giao
    socket.on('new_task', data => {
      console.log('üì• New task assigned:', data);
    });

    // task ƒë∆∞·ª£c member c·∫≠p nh·∫≠t progress
    socket.on('task_updated', data => {
      console.log('Member updated task:', data);

      const row = document.querySelector(`#task-row-${data.task_id}`);
      if (row) {
        row.querySelector('.status-cell').textContent = data.status;
        row.querySelector('.progress-cell').textContent = data.progress + '%';
      }
    });
  </script>
{% endblock %}

